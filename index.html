<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Buy BRICS Token</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f3f6fa; text-align:center; padding:30px; color:#111; }
.card { background:#fff; border-radius:14px; padding:26px; max-width:820px; margin:auto; box-shadow:0 8px 30px rgba(0,0,0,0.08);}
h2 { color:#007bff; margin-bottom:6px; }
input, button { width:90%; padding:12px; margin:10px 0; border-radius:10px; border:1px solid #ccc; font-size:16px;}
button { background:#007bff; color:#fff; cursor:pointer; font-weight:600; border:none; }
button:disabled { opacity:0.6; cursor:not-allowed;}
.copy-btn { background:transparent; border:none; color:#007bff; cursor:pointer; margin-left:8px; font-size:14px;}
.info-box { background:#f5f8ff; border-radius:10px; padding:14px; margin-top:18px; font-size:14px; color:#333; line-height:1.6; text-align:left; max-width:720px; margin-left:auto; margin-right:auto;}
.status { color:#007bff; font-weight:600; margin-top:8px; min-height:22px;}
.discount-info { margin-top:10px; color:#00a36c; font-weight:700;}
.price-info { margin-top:10px; color:#333; font-weight:600;}
.wallet-display { font-size:14px; color:#333; margin-top:8px;}
hr { border:0; border-top:1px solid #eee; margin:18px 0; }
.spinner { display:inline-block; width:18px; height:18px; border:3px solid rgba(0,0,0,0.12); border-top-color:#007bff; border-radius:50%; animation: spin 1s linear infinite; vertical-align:middle; margin-left:8px; visibility:hidden; }
.spinner.visible { visibility: visible; }
@keyframes spin { to { transform: rotate(360deg); } }
.meta-row { display:flex; justify-content:center; align-items:center; gap:8px; flex-wrap:wrap;}
.small-muted { font-size:13px; color:#666; margin-top:6px;}
</style>
</head>
<body>

<div class="card">
<img src="bricslogo.png" alt="BRICS Logo" width="96"/>
<h2>Buy BRICS Token</h2>

<p style="font-weight:600;">Please add this contract address to your MetaMask before buying:</p>
<div class="meta-row">
<p id="contractDisplay" style="font-size:16px; font-weight:700; margin:0;">
<span id="contractShort">0xAF20...3037</span>
</p>
<button id="copyContract" class="copy-btn">Copy</button>
</div>
<div class="small-muted">Add the token contract in MetaMask to see token details before purchase.</div>

<hr/>

<p style="font-weight:600;">Enter amount of BRICS to buy:</p>
<input id="bricsAmount" type="number" placeholder="e.g. 1000" min="1"/>

<div style="margin-top:6px;">
<button id="connectBtn">Connect MetaMask</button>
<div class="wallet-display" id="walletInfo"></div>
</div>

<button id="buyBtn" disabled style="margin-top:14px;">Buy BRICS</button>

<div class="price-info" id="priceInfo">Live BRICS price: loading... <span class="spinner" id="priceSpinner"></span></div>
<div class="discount-info" id="discountInfo"></div>
<div class="price-info" id="totalInfo"></div>
<p id="status" class="status"></p>

<div class="info-box">
<strong>Important Notice:</strong><br>
BRICS Token will be listed in <strong>February 2026</strong> and will only be exchangeable with the official currencies of BRICS member countries.<br><br>
Accepted payment: <strong>BNB (BEP20)</strong> — Network: <strong>BNB Smart Chain</strong>.<br>
Price source: PancakeSwap pair (live) and BNB→USD via Binance public API.
</div>
</div>

<script>
const BRICS_CONTRACT = "0xAF2009350F6ECBE22c23A505a590239c7aaA3037";
const PANCAKE_PAIR = "0xAF2009350F6ECBE22c23A505a590239c7aaA3037";
const CHAIN_ID_BSC = 56;
const WBNB = "0xBB4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c".toLowerCase();
const PAIR_ABI = ["function getReserves() view returns (uint112,uint112,uint32)","function token0() view returns (address)","function token1() view returns (address)"];
const BRICS_ABI = ["function buyWithBNB() payable"];

const connectBtn = document.getElementById("connectBtn");
const buyBtn = document.getElementById("buyBtn");
const walletInfo = document.getElementById("walletInfo");
const statusEl = document.getElementById("status");
const discountInfo = document.getElementById("discountInfo");
const priceInfo = document.getElementById("priceInfo");
const totalInfo = document.getElementById("totalInfo");
const copyBtn = document.getElementById("copyContract");
const bricsInput = document.getElementById("bricsAmount");
const contractShort = document.getElementById("contractShort");
const spinner = document.getElementById("priceSpinner");

let provider = null, signer = null, userAddress = null;
let priceScaled = null, bricsPriceBNB=0, bnbUsdPrice=0;
let updateTimer = null;

function shortAddr(addr){ if(!addr||addr.length<10)return addr; return addr.slice(0,6)+"..."+addr.slice(-4);}
contractShort.textContent = shortAddr(BRICS_CONTRACT);
copyBtn.onclick = async()=>{ try{ await navigator.clipboard.writeText(BRICS_CONTRACT); alert("BRICS contract address copied to clipboard"); }catch(e){ alert("Copy failed. Copy manually: "+BRICS_CONTRACT); } };

function setStatus(txt){ statusEl.textContent=txt; }
function showSpinner(show){ if(show) spinner.classList.toggle('visible',show); }

async function connectWallet(){
if(!window.ethereum){ alert("Install MetaMask."); return; }
provider = new ethers.providers.Web3Provider(window.ethereum);
try{
const net=await provider.getNetwork();
if(net.chainId!==CHAIN_ID_BSC){
await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:ethers.utils.hexValue(CHAIN_ID_BSC)}]});
}
await provider.send("eth_requestAccounts",[]);
signer=provider.getSigner();
userAddress=await signer.getAddress();
walletInfo.textContent=shortAddr(userAddress);
connectBtn.textContent="Connected"; connectBtn.disabled=true;
setStatus("Wallet connected"); updateBuyBtnState();
}catch(e){ console.error(e); setStatus("Connection failed: "+(e.message||e)); }
}

function calculateDiscount(amount){
const a=Number(amount); if(!a||a<=0)return 0;
if(a<100) return 0;
if(a>=1000000) return 50;
const ratio=(a-100)/(1000000-100);
return Math.round(ratio*50*100)/100;
}

async function fetchLivePriceScaled(){
const rpc = provider||new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
const pair = new ethers.Contract(PANCAKE_PAIR,PAIR_ABI,rpc);
const [t0,t1]=await Promise.all([pair.token0(),pair.token1()]);
const reserves=await pair.getReserves();
let reserveWBNB, reserveBRICS;
if(t0.toLowerCase()===WBNB){ reserveWBNB=reserves[0]; reserveBRICS=reserves[1]; } 
else if(t1.toLowerCase()===WBNB){ reserveWBNB=reserves[1]; reserveBRICS=reserves[0]; } 
else throw new Error("WBNB not found in pair.");
const priceScaledLocal=reserveWBNB.mul(ethers.constants.WeiPerEther).div(reserveBRICS);
return priceScaledLocal;
}

async function fetchBnbUsd(){ try{ const res=await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT"); const j=await res.json(); return parseFloat(j.price); } catch(e){ console.error("BNB->USD fetch failed",e); return null;} }

async function updatePrices(){
try{ showSpinner(true); setStatus("Updating live prices...");
const [pscaled,bnbusd]=await Promise.allSettled([fetchLivePriceScaled(),fetchBnbUsd()]);
if(pscaled.status==="fulfilled"){ priceScaled=pscaled.value; bricsPriceBNB=parseFloat(ethers.utils.formatEther(priceScaled)); } 
if(bnbusd.status==="fulfilled") bnbUsdPrice=bnbusd.value||0;
if(priceScaled && bnbUsdPrice) { priceInfo.innerHTML=`Live BRICS price: ${bricsPriceBNB.toFixed(6)} BNB (~$${(bricsPriceBNB*bnbUsdPrice).toFixed(2)} USD)`; } 
else priceInfo.innerHTML="Live BRICS price unavailable";
setStatus(""); showSpinner(false);
updateBuyBtnState();
}catch(e){ console.error(e); showSpinner(false); setStatus("Price update failed."); }
}

function updateBuyBtnState(){ buyBtn.disabled=!userAddress||!bricsPriceBNB; }

async function buyBRICS(){
if(!signer){ setStatus("Connect wallet first."); return; }
const amount=Number(bricsInput.value); if(!amount||amount<=0){ setStatus("Enter valid BRICS amount"); return; }
const discount=calculateDiscount(amount);
discountInfo.textContent=`Discount: ${discount}%`;
const bricsAfterDisc=amount*(1-discount/100);
const totalBNB=bricsAfterDisc*bricsPriceBNB;
totalInfo.textContent=`Total payment: ${totalBNB.toFixed(6)} BNB (~$${(totalBNB*bnbUsdPrice).toFixed(2)} USD)`;
try{
setStatus("Waiting for transaction approval...");
const contract=new ethers.Contract(BRICS_CONTRACT,BRICS_ABI,signer);
const tx=await contract.buyWithBNB({value: ethers.utils.parseEther(totalBNB.toFixed(18))});
setStatus("Transaction sent: "+shortAddr(tx.hash));
await tx.wait();
setStatus("✅ BRICS purchased successfully!");
// TX log to backend
try{ await fetch("https://your-server.com/api/log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet:userAddress,amountBrics:amount,totalBNB:totalBNB,discountPercent:discount,txHash:tx.hash,timestamp:new Date().toISOString()})}); }catch(e){ console.error("TX log failed",e);}
}catch(e){ console.error(e); setStatus("Transaction failed: "+(e.message||e)); }
}

connectBtn.addEventListener("click",connectWallet);
buyBtn.addEventListener("click",buyBRICS);

updatePrices(); setInterval(updatePrices,10000);
</script>
</body>
</html>
