<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Buy BRICS Token</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root{--blue:#007bff;--soft:#f3f6fa;--card:#fff;--accent:#00a36c;}
  body{font-family:Arial, sans-serif;background:var(--soft);padding:20px;direction:rtl;color:#111;}
  .wrap{max-width:420px;margin:12px auto;}
  .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.08);}
  .map-wrap{position:relative;border-radius:12px;overflow:hidden;margin-bottom:14px;height:120px;background:#e9eef8}
  .map-wrap img{width:100%;height:100%;object-fit:cover;display:block;opacity:0.95}
  .logo-circle{position:absolute;left:50%;top:14px;transform:translateX(-50%);width:76px;height:76px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;border:3px solid rgba(0,0,0,0.06)}
  h2{color:var(--blue);text-align:center;margin:8px 0 4px;font-size:22px}
  .muted{font-size:13px;color:#555;text-align:center;margin-bottom:8px;font-weight:600}
  .contract-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px;flex-wrap:wrap}
  .contract-text{font-weight:700;direction:ltr;background:#f7f9ff;padding:8px 12px;border-radius:8px;border:1px solid #eee}
  .copy-btn{background:transparent;border:none;color:var(--blue);cursor:pointer;font-weight:700}
  .price-line{margin-top:8px;text-align:center;font-weight:700}
  .spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(0,0,0,0.12);border-top-color:var(--blue);border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-left:8px;visibility:hidden}
  .spinner.visible{visibility:visible}
  @keyframes spin{to{transform:rotate(360deg)}}
  .input-row{display:flex;gap:8px;align-items:center;margin-top:12px}
  .input-left{flex:1;display:flex;flex-direction:column}
  .input-left input{padding:10px;border-radius:10px;border:1px solid #ddd;font-size:16px;width:100%;box-sizing:border-box}
  .token-badge{min-width:78px;background:#f3f7ff;border-radius:10px;padding:10px;text-align:center;font-weight:800;font-size:16px;color:#222;border:1px solid #eee}
  .calc-top{display:flex;justify-content:space-between;margin-top:8px;font-size:13px;color:#444}
  .memo-box{margin-top:12px;background:#f5f8ff;padding:8px;border-radius:8px;font-size:13px}
  .wallet-row{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .wallet-info{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;border:1px solid #eee;background:#fff}
  .connect-btn{padding:12px;border-radius:12px;border:none;background:var(--blue);color:#fff;font-weight:700;cursor:pointer}
  .buy-btn{padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,#59a7ff,#2f7bea);color:#fff;font-weight:800;cursor:pointer;margin-top:12px;width:100%}
  .buy-btn:disabled{opacity:0.6;cursor:not-allowed}
  .status{margin-top:10px;font-size:14px;min-height:20px}
  .info-small{font-size:12px;color:#666;margin-top:10px}
  .success{color:green;font-weight:700}
  .error{color:#c0392b;font-weight:700}
  @media (max-width:420px){ .map-wrap{height:100px} .logo-circle{top:8px;width:64px;height:64px} h2{font-size:20px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="map-wrap">
      <img src="brics-map.jpg" alt="BRICS map"/>
      <div class="logo-circle"><img src="bricslogo.png" alt="logo" style="width:100%;height:100%"/></div>
    </div>

    <h2>Buy BRICS Token</h2>
    <div class="muted">لطفاً آدرس قرارداد را به MetaMask اضافه کنید تا قبل از خرید توکن را مشاهده کنید</div>

    <div class="contract-row">
      <div id="contractText" class="contract-text" title="Click to copy">0xAF20...3037</div>
      <button id="copyBtn" class="copy-btn">Copy</button>
    </div>

    <div class="price-line" id="priceLine">قیمت لحظه‌ای: در حال دریافت <span class="spinner" id="priceSpinner"></span></div>

    <div class="calc-top">
      <div id="usdPreview">USD: $0.00</div>
      <div id="discountPreview">تخفیف: 0%</div>
    </div>

    <div class="input-row">
      <div class="input-left">
        <input id="bricsAmount" type="number" min="1" placeholder="مثال: 1000" />
      </div>
      <div class="token-badge">BRICS</div>
    </div>

    <div class="memo-box">
      <div><strong>MEMO TAG :</strong> <span id="memoTag">—</span></div>
      <div style="margin-top:6px"><small> هنگام انتقال BNB این MEMO را وارد کنید تا تراکنش به درستی پردازش شود.</small></div>
    </div>

    <div class="wallet-row">
      <div id="walletDisplay" class="wallet-info">
        <div>My Wallet: <span id="walletAddr">—</span></div>
        <div style="text-align:left"><small id="connectState">Not connected</small></div>
      </div>

      <div id="balances" style="display:none;flex-direction:column;gap:6px;margin-top:6px">
        <div class="wallet-info"><div>BNB:</div><div id="bnbBal">0 BNB</div></div>
        <div class="wallet-info"><div>BRICS:</div><div id="bricsBal">0 BRICS</div></div>
      </div>

      <button id="connectBtn" class="connect-btn">Connect MetaMask</button>
    </div>

    <button id="buyBtn" class="buy-btn" disabled>Buy BRICS</button>

    <div id="status" class="status"></div>
    <div class="info-small">Accepted payment: <strong>BNB (BEP20)</strong> — Network: <strong>BNB Smart Chain (56)</strong></div>
  </div>
</div>

<script>
/* =========== CONFIG =========== */
const BRICS_CONTRACT = "0xAF2009350F6ECBE22c23A505a590239c7aaA3037".toLowerCase();
const PANCAKE_PAIR = "0xAF2009350F6ECBE22c23A505a590239c7aaA3037".toLowerCase(); // example — use real pair address if different
const CHAIN_ID_BSC = 56;
const WBNB = "0xBB4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c".toLowerCase();
const PAIR_ABI = ["function getReserves() view returns (uint112,uint112,uint32)","function token0() view returns (address)","function token1() view returns (address)"];
const ERC20_ABI = ["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"];
const BRICS_ABI = ["function buyWithBNB() payable"]; // تابع قرارداد خرید — در قرارداد شما ممکن است فرق کند
/* ============================== */

const contractText = document.getElementById('contractText');
const copyBtn = document.getElementById('copyBtn');
const priceLine = document.getElementById('priceLine');
const priceSpinner = document.getElementById('priceSpinner');
const bricsInput = document.getElementById('bricsAmount');
const usdPreview = document.getElementById('usdPreview');
const discountPreview = document.getElementById('discountPreview');
const memoTagEl = document.getElementById('memoTag');
const connectBtn = document.getElementById('connectBtn');
const walletAddrEl = document.getElementById('walletAddr');
const connectState = document.getElementById('connectState');
const balancesDiv = document.getElementById('balances');
const bnbBalEl = document.getElementById('bnbBal');
const bricsBalEl = document.getElementById('bricsBal');
const buyBtn = document.getElementById('buyBtn');
const statusEl = document.getElementById('status');

contractText.textContent = shortAddr(BRICS_CONTRACT);

/* small helpers */
function shortAddr(a){ if(!a) return '—'; return a.slice(0,6)+'...'+a.slice(-4); }
function isMobile(){ return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent); }
function setStatus(msg, cls){ statusEl.className = 'status'; if(cls) statusEl.classList.add(cls); statusEl.textContent = msg; }

/* copy contract */
copyBtn.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(BRICS_CONTRACT); setStatus('آدرس قرارداد کپی شد ✅', 'success'); }
  catch(e){ setStatus('کپی نشد — لطفاً دستی کپی کنید', 'error'); console.error(e); }
});

/* generate memo tag */
function genMemo(){
  const s = Math.random().toString(36).slice(2,10).toUpperCase();
  memoTagEl.textContent = s;
  return s;
}
let currentMemo = genMemo();

/* price fetchers */
let providerRpc = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
let priceScaledBN = null; // price as BigNumber scaled to 1e18 (BRICS price in BNB)
let bricsPriceBNB = 0;
let bnbUsdPrice = 0;

async function fetchPairPrice(){
  try{
    const pair = new ethers.Contract(PANCAKE_PAIR, PAIR_ABI, providerRpc);
    const [t0,t1] = await Promise.all([pair.token0(), pair.token1()]);
    const reserves = await pair.getReserves(); // reserve0, reserve1, ts
    let reserveWBNB, reserveBRICS;
    if(t0.toLowerCase() === WBNB){ reserveWBNB = reserves[0]; reserveBRICS = reserves[1]; }
    else if(t1.toLowerCase() === WBNB){ reserveWBNB = reserves[1]; reserveBRICS = reserves[0]; }
    else { throw new Error('WBNB not in pair'); }
    // price = reserveWBNB / reserveBRICS (scaled by 1e18)
    const scaled = reserveWBNB.mul(ethers.constants.WeiPerEther).div(reserveBRICS);
    priceScaledBN = scaled;
    bricsPriceBNB = parseFloat(ethers.utils.formatEther(priceScaledBN));
    return bricsPriceBNB;
  }catch(e){ console.error('pair price failed', e); priceScaledBN = null; bricsPriceBNB = 0; throw e; }
}

async function fetchBnbUsd(){
  try{
    const res = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT");
    const j = await res.json();
    bnbUsdPrice = parseFloat(j.price);
    return bnbUsdPrice;
  }catch(e){ console.error('bnbusd failed', e); bnbUsdPrice = 0; throw e; }
}

async function updatePricesUI(){
  priceSpinner.classList.add('visible');
  try{
    await Promise.allSettled([fetchPairPrice(), fetchBnbUsd()]);
    if(bricsPriceBNB && bnbUsdPrice){
      priceLine.innerHTML = `قیمت BRICS: ${bricsPriceBNB.toFixed(8)} BNB (~$${(bricsPriceBNB*bnbUsdPrice).toFixed(4)} )`;
    } else {
      priceLine.textContent = 'قیمت لحظه‌ای ناموجود';
    }
  }catch(e){
    priceLine.textContent = 'قیمت لحظه‌ای ناموجود';
  }finally{
    priceSpinner.classList.remove('visible');
    updateCalcPreview();
  }
}
updatePricesUI();
setInterval(updatePricesUI, 10000);

/* discount calc:
   if amount < 100 => 0%
   if amount >= 1000000 => 50%
   else linear between 100..1000000 -> 0..50 */
function calcDiscount(amount){
  const a = Number(amount);
  if(!a || a < 100) return 0;
  if(a >= 1000000) return 50;
  const ratio = (a - 100) / (1000000 - 100);
  return Math.round(ratio * 50 * 100) / 100;
}

/* update preview (USD / discount) */
function updateCalcPreview(){
  const a = Number(bricsInput.value);
  const discount = calcDiscount(a);
  discountPreview.textContent = `تخفیف: ${discount}%`;
  if(!a || !bricsPriceBNB || !bnbUsdPrice){
    usdPreview.textContent = `USD: $0.00`;
  } else {
    const after = a * (1 - discount/100);
    const totalBNB = after * bricsPriceBNB;
    const totalUSD = totalBNB * bnbUsdPrice;
    usdPreview.textContent = `USD: $${totalUSD.toFixed(2)}`;
  }
  // enable buy when input valid and connected and prices known
  updateBuyState();
}
bricsInput.addEventListener('input', ()=>{
  updateCalcPreview();
  // regenerate memo when amount changes (optionally)
  // currentMemo = genMemo();
});

/* Wallet connect & balances */
let provider = null, signer = null, userAddress = null;

async function detectAndConnect(){
  if(window.ethereum){
    provider = new ethers.providers.Web3Provider(window.ethereum);
    try{
      const net = await provider.getNetwork();
      if(net.chainId !== CHAIN_ID_BSC){
        // try to switch
        try{
          await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: ethers.utils.hexValue(CHAIN_ID_BSC) }] });
        }catch(switchErr){ console.warn('chain switch failed', switchErr); }
      }
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      walletAddrEl.textContent = shortAddr(userAddress);
      connectState.textContent = 'Connected';
      connectBtn.textContent = 'Connected';
      connectBtn.disabled = true;
      await updateBalances();
      setStatus('کیف پول متصل شد ✅', 'success');
    }catch(e){
      console.error(e);
      setStatus('اتصال ناموفق: '+(e.message||e), 'error');
    }
  } else {
    // no injected provider
    if(isMobile()){
      // try deep link into MetaMask mobile (fallback)
      const dappUrl = window.location.href.replace(/^https?:\/\//,'');
      const mmUrl = `https://metamask.app.link/dapp/${dappUrl}`;
      setStatus('متامسک نصب نیست — تلاش برای باز کردن MetaMask mobile...', '');
      window.location.href = mmUrl;
    } else {
      setStatus('MetaMask پیدا نشد — لطفاً افزونه MetaMask را نصب کنید', 'error');
      // optionally show link to install
    }
  }
}

async function updateBalances(){
  if(!signer) return;
  try{
    const bnbBal = await provider.getBalance(userAddress);
    const bnbFormatted = parseFloat(ethers.utils.formatEther(bnbBal));
    bnbBalEl.textContent = `${bnbFormatted.toFixed(6)} BNB (~$${(bnbFormatted*bnbUsdPrice).toFixed(2)})`;

    // BRICS token balance
    const token = new ethers.Contract(BRICS_CONTRACT, ERC20_ABI, provider);
    let decimals = 18;
    try{ decimals = await token.decimals(); }catch(e){ decimals = 18; }
    const raw = await token.balanceOf(userAddress);
    const bricsFormatted = parseFloat(ethers.utils.formatUnits(raw, decimals));
    bricsBalEl.textContent = `${bricsFormatted.toFixed(4)} BRICS (~$${(bricsFormatted * bricsPriceBNB * bnbUsdPrice).toFixed(2)})`;

    balancesDiv.style.display = 'flex';
    updateBuyState();
  }catch(e){ console.error('balances failed', e); }
}

/* buy flow */
function updateBuyState(){
  const amount = Number(bricsInput.value);
  const discount = calcDiscount(amount);
  const ready = Boolean(signer && amount > 0 && bricsPriceBNB && bnbUsdPrice);
  buyBtn.disabled = !ready;
}

async function buyBRICS(){
  if(!signer){ setStatus('ابتدا کیف خود را متصل کنید', 'error'); return; }
  const amount = Number(bricsInput.value);
  if(!amount || amount <= 0){ setStatus('مقدار BRICS معتبر وارد کنید', 'error'); return; }
  const discount = calcDiscount(amount);
  const bricsAfter = amount * (1 - discount/100);
  const totalBNB = bricsAfter * bricsPriceBNB;
  setStatus('منتظر تایید تراکنش در کیف پول...', '');
  try{
    const contract = new ethers.Contract(BRICS_CONTRACT, BRICS_ABI, signer);
    // convert BNB amount to wei
    const valueWei = ethers.utils.parseUnits(totalBNB.toFixed(18), 'ether');
    const tx = await contract.buyWithBNB({ value: valueWei });
    setStatus('تراکنش ارسال شد: ' + shortAddr(tx.hash), '');
    await tx.wait();
    setStatus('✅ BRICS با موفقیت ارسال شد — Tx: ' + tx.hash, 'success');
    // refresh balances
    await updateBalances();
    // regenerate memo to avoid reuse
    currentMemo = genMemo();
    // optionally show a green popup or toast here
  }catch(e){
    console.error(e);
    setStatus('خطا در ارسال تراکنش: '+(e.message||e), 'error');
  }
}

/* UI event bindings */
connectBtn.addEventListener('click', detectAndConnect);
buyBtn.addEventListener('click', buyBRICS);
bricsInput.addEventListener('input', updateCalcPreview);

/* initial MEMO shown */
memoTagEl.textContent = currentMemo;

/* show contract short clickable to copy */
contractText.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(BRICS_CONTRACT); setStatus('آدرس قرارداد کپی شد ✅', 'success'); }catch(e){ setStatus('کپی دستی: '+BRICS_CONTRACT, 'error'); } });

/* keep UI price updates reacting to external changes */
setInterval(updateCalcPreview, 1200);

</script>
</body>
</html>
