<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Buy BRICS Token</title>
<meta name="theme-color" content="#0b63ff"/>
<style>
  /* --- همان استایل‌های قبلی شما --- */
</style>
</head>
<body>
<div class="container">
  <div class="card" role="main">
    <!-- ... بقیه HTML همانند قبل ... -->
    <input id="bricsAmount" class="amount-input" type="number" min="1" max="2000000" placeholder="e.g. 1000" />
    <div id="memoTag">—</div>
    <button id="depositBtn" class="deposit-btn">Proceed to Payment</button>
    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <h3>Confirm Your Purchase</h3>
        <div id="modalSummary" class="summary"></div>
        <label>TX Hash (required)</label>
        <input id="modalTxHash" placeholder="0x..." />
        <div class="actions">
          <button id="modalCancel" class="btn ghost">Cancel</button>
          <button id="modalSubmit" class="btn primary">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const REAL_VALUE = 6.17;
const BRICS_CONTRACT="0xAF2009350F6ECBE22c23A505a590239c7aaA3037".toLowerCase();
const OWNER_ADDRESS="0x67594E1D30Cec8a5f906C8278A1BC694641486cf".toLowerCase();

const bricsAmount=document.getElementById('bricsAmount');
const depositBtn=document.getElementById('depositBtn');
const modalBackdrop=document.getElementById('modalBackdrop');
const modalSummary=document.getElementById('modalSummary');
const modalCancel=document.getElementById('modalCancel');
const modalTxHash=document.getElementById('modalTxHash');
const modalSubmit=document.getElementById('modalSubmit');
const memoTag=document.getElementById('memoTag');

// --- مدیریت MEMO ---
let memoValue = localStorage.getItem("currentMemo");
if (!memoValue) {
  memoValue = generateMemo();
  localStorage.setItem("currentMemo", memoValue);
}
memoTag.textContent = memoValue;

function generateMemo(){
  const t = Date.now().toString(36).slice(-5);
  return "BRX-" + t;
}

// --- ارسال پیام به Cloudflare Worker ---
async function sendToTelegram(txHash, memo, amount) {
  const msg = `
🪙 *New BRICS Purchase!*
Amount: ${amount} BRICS
Memo: ${memo}
TX Hash: ${txHash}
Date: ${new Date().toLocaleString()}
  `;

  try {
    const workerURL = "https://holy-hall-baaf.hadivideo.workers.dev"; // لینک واقعی Worker شما
    await fetch(`${workerURL}/?msg=${encodeURIComponent(msg)}`, {
      method: 'GET',
      mode: 'cors',
    });
    console.log("✅ Message sent to Telegram");
  } catch (err) {
    console.error("❌ Error sending to Telegram", err);
  }
}

// --- باز شدن مودال ---
depositBtn.onclick=()=>{
  const amount=Number(bricsAmount.value);
  if(!amount)return alert("Enter BRICS amount first.");
  memoValue=generateMemo();
  memoTag.textContent = memoValue;
  modalSummary.textContent=`Amount: ${amount} BRICS\nMEMO: ${memoValue}`;
  modalBackdrop.style.display='flex';
};

// --- بستن مودال ---
modalCancel.onclick=()=>modalBackdrop.style.display='none';

// --- ارسال تراکنش و پیام به Worker ---
modalSubmit.onclick = async () => {
  const txHash = modalTxHash.value.trim();
  const amount = Number(bricsAmount.value);
  if(!txHash || !amount) return alert("Please enter TX Hash and amount.");

  walletAddr.textContent = "0x" + txHash.slice(2,6) + "..." + txHash.slice(-4);
  modalBackdrop.style.display = 'none';
  alert("Transaction submitted ✅");

  // ارسال پیام به Cloudflare Worker
  await sendToTelegram(txHash, memoValue, amount);

  // ممو جدید بساز
  memoValue = generateMemo();
  localStorage.setItem("currentMemo", memoValue);
  memoTag.textContent = memoValue;
};
</script>
</body>
</html>
